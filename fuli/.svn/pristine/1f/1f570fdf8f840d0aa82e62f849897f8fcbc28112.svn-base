package net.loyin.ctrl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import net.loyin.jfinal.anatation.RouteBind;
import net.loyin.model.sys.Wxmenu;

import com.alibaba.fastjson.JSON;
import com.gson.WeChat;
/**
 * 微信菜单管理
 * @author 龙影
 */
@RouteBind(path = "/wxmenu")
public class WxmenuCtrl extends AdminBaseController<Wxmenu> {
	public WxmenuCtrl(){
		this.tableName=Wxmenu.tableName;
		this.modelClass=Wxmenu.class;
	}
	public void edit(){
		super.edit();
		this.setAttr("WxmenuList", Wxmenu.dao.find("select * from "+tableName+" order by listorder asc"));
	}
	/**创建微信菜单到公众号*/
	public void createMenu(){
		List<Wxmenu> list=Wxmenu.dao.findTopMenuList();// 获取菜单
		if (list != null) {
			Map<String,Object> btns=new HashMap<String,Object>();
			List<Map<String,Object>> btnlist=new ArrayList<Map<String,Object>>();
			for (Wxmenu map:list) {
				List<Wxmenu> listSub = Wxmenu.dao.getByPid(map.getLong("id"),1);
				Map<String,Object> btn=new HashMap<String,Object>();
				btn.put("name",map.get("name"));
				if (listSub == null||listSub.isEmpty()) {
					btn.put("type",map.get("type"));
					String type=map.get("type");
					if("view".equals(type)){
						btn.put("url",map.get("url"));
					}
					btn.put("key",map.get("key"));
				} else {
					List<Map<String,Object>> sublist=new ArrayList<Map<String,Object>>();
					for (Wxmenu mapSub : listSub) {
						Map<String,Object> sbtn=new HashMap<String,Object>();
						sbtn.put("name",mapSub.get("name"));
						sbtn.put("type",mapSub.get("type"));
						String type=mapSub.get("type");
						if("view".equals(type)){
							sbtn.put("url",sbtn.get("url"));
						}
						sbtn.put("key",mapSub.get("key"));
						sublist.add(sbtn);
					}
					if(sublist.isEmpty()==false)
					btn.put("sub_button",sublist);
				}
				btnlist.add(btn);
			}
			btns.put("button", btnlist);
			String btnStr=JSON.toJSONString(btns);//gson.toJson(btns);
			log.info("按钮："+btnStr);
			// 发送菜单
			boolean result =false;
			String resultMsg="";
			try {
				result=WeChat.menu.createMenu(WeChat.getAccessToken(), btnStr,resultMsg);
			} catch (Exception e) {
				log.error("创建微信菜单异常",e);
			}
			if (result) {
				this.rendJson_(true, "创建成功！");
			} else {
				this.rendJson_(false, "创建失败！"+resultMsg);
			}
		}
	}
	/**删除微信菜单*/
	public void delMenu(){
		boolean result =false;
		try {
			result=WeChat.menu.deleteMenu(WeChat.getAccessToken());
		} catch (Exception e){
			log.error("创建微信菜单异常",e);
		}
		if (result){
			this.rendJson_(true, "创建成功！");
		} else {
			this.rendJson_(false, "创建失败！");
		}
	}
}
