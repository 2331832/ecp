package net.loyin.util.wechat;

import java.io.IOException;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import net.loyin.util.safe.SHAUtil;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;

public class CheckingUtil {
	private CheckingUtil() {
	}

	private static Log log = LogFactory.getLog(CheckingUtil.class);

	public static void doCheck(HttpServletRequest req, HttpServletResponse resp, String TOKEN) throws IOException {
		String signature = req.getParameter("signature");
		String timestamp = req.getParameter("timestamp");
		String nonce = req.getParameter("nonce");
		String echostr = req.getParameter("echostr");
		List<String> list = new ArrayList<String>();
		list.add(TOKEN);
		list.add(timestamp);
		list.add(nonce);
		Collections.sort(list); // 将token、timestamp、nonce三个参数进行字典序排序
		String sha = SHAUtil.SHA1Encode(list.get(0) + list.get(1) + list.get(2)); // 将三个参数字符串拼接成一个字符串进行sha1加密
		if (signature.equals(sha)) {
			PrintWriter out = resp.getWriter();
			out.write(echostr);
		} else {
			log.error("验证不通过，其错误信息为: " + TOKEN);
		}
	}
}
