package net.loyin.model.sys;

import java.util.ArrayList;
import java.util.List;

import net.loyin.jfinal.anatation.TableBind;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.gson.WeChat;
import com.gson.bean.UserInfo;
import com.jfinal.plugin.activerecord.Model;
/**
 * 微信用户
 * @author 龙影
 */
@TableBind(name="sp_wx_user")
public class WxUser extends Model<WxUser> {
	private static final long serialVersionUID = 72274314871183505L;
	public static final String tableName="sp_wx_user";
	public static WxUser dao=new WxUser();
	public void insert() throws Exception {
		List<String> openIdList=new ArrayList<String>();
		JSONObject jo1 =WeChat.user.getFollwersList(WeChat.getAccessToken(),"");
		openIdList=getOpenidList(jo1.getJSONObject("data"));
		/*Object[][] paras=new Object[1][openIdList.size()];
		int i=0;
		for(String id:openIdList){
			paras[i++]=new Object[]{id};
		}
		Db.batch("INSERT INTO "+tableName+" (openid) values(?)",paras,openIdList.size());*/
		for(String id:openIdList){
			try{
				getFromOpenId(id);
			}catch(Exception e){
				continue;
			}
		}
	}
	/**提过openId获取用户信息*/
	public WxUser getFromOpenId(String openId) throws Exception{
		UserInfo jo =WeChat.user.getUserInfo(WeChat.getAccessToken(),openId);
		if (jo != null) {
			WxUser u=new WxUser();
			try{
				u.set("subscribe",jo.getSubscribe());
				u.set("openid",jo.getOpenid());
				u.set("nickname",jo.getNickname());
				u.set("sex",jo.getSex());
				u.set("language",jo.getLanguage());
				u.set("city",jo.getCity());
				u.set("province",jo.getProvince());
				u.set("country",jo.getCountry());
				u.set("headimgurl",jo.getHeadimgurl());
				u.set("subscribe_time",jo.getSubscribe_time());
				u.save();
			}catch(Exception e){
				u=u.findByOpenId(jo.getOpenid());
				if(u!=null){
					u.update();
				}
			}
			return u;
		}
		return null;
	}
	private List<String> getOpenidList(JSONObject j) {
		List<String> strList = new ArrayList<String>();
		JSONArray ja =j.getJSONArray("openid");
		for (Object o : ja) {
			strList.add(o.toString());
		}
		return strList;
	}
	public WxUser findByOpenId(String openid) {
		return this.findFirst("select * from "+tableName+" where openid=?",openid);
	}
}
