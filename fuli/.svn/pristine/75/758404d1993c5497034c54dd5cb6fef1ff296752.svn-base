package net.loyin.ctrl;

import java.util.ArrayList;
import java.util.List;

import net.loyin.jfinal.anatation.RouteBind;
import net.loyin.model.sys.Jbmember;
import net.loyin.model.sys.Jiubang;
import net.loyin.model.sys.WxUser;

import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;
/***
 * 酒帮管理
 * @author 龙影
 */
@RouteBind(path = "/jiubang")
public class JiubangCtrl extends AdminBaseController<Jiubang> {
	public JiubangCtrl() {
		this.tableName = Jiubang.tableName;
		this.modelClass = Jiubang.class;
	}

	public void list() {
		List<Object> param = new ArrayList<Object>();
		StringBuffer where = new StringBuffer();
		String key=this.getPara("key");
		if(key!=null&&!"".equals(key)){
			where.append(" and (nickname like ? or uname like ? or phone)");
			param.add("%"+key+"%");
			param.add("%"+key+"%");
			param.add("%"+key+"%");
		}
		/** 添加查询字段条件 */
		qryField(where, param);
		sortField(where);
		where.append(" group by t.id ");
		Page<Record> p = Db
				.paginate(
						getPageNo(),
						getPageSize(),
						"select t.*,w.openid,w.nickname,w.sex,w.city,w.province,w.headimgurl,w.uname,w.phone,count(jm.id),sum(w1.amt) ",
						"from " + this.tableName + " t left join " + Jbmember.tableName
								+ " jm on jm.jbid=t.id left join " + WxUser.tableName
								+ " w1 on w1.id=jm.wxuid," + WxUser.tableName
								+ " w where w.id=t.wxuid " + where.toString(),
						param.toArray());
		this.setAttr("page", p);
	}
}
