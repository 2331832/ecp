package net.loyin.model.sys;

import java.util.Date;
import java.util.List;

import net.loyin.jfinal.anatation.TableBind;

import com.jfinal.aop.Before;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Model;
import com.jfinal.plugin.activerecord.Record;
import com.jfinal.plugin.activerecord.tx.Tx;
/***
 * 微信用户收益
 * @author 刘声凤
 *  2012-9-4 上午10:39:04
 */
@TableBind(name="sp_wxincome",pk="ID")
public class WxIncome extends Model<WxIncome> {
	private static final long serialVersionUID = 250465353298698300L;
	public static String tableName="sp_wxincome";
	public static final WxIncome dao=new WxIncome();
	@Before(Tx.class)
	public void insert(double amt,int typ,String openid){
		WxUser u=WxUser.dao.findByOpenId(openid);
		Long uid=u.getLong("id");
		WxIncome po=new WxIncome();
		po.set("amt",amt);
		po.set("openid", openid);
		po.set("ctime",new Date());
		po.set("typ",typ);
		po.set("uid",uid);
		po.save();
		if(typ==0)
			Db.update("update "+WxUser.tableName+" set fanli1=fanli1+?,buyct=1 where id=?",amt,uid);
		if(typ==1)
			Db.update("update "+WxUser.tableName+" set bonus1=bonus1+? where id=?",amt,uid);
	}
	/**结算当月*/
	@Before(Tx.class)
	public void js(){
		Db.update("insert into SP_JSRECORD (uid,amt,ctime) select uid,sum(amt) amt,now() from sp_wxincome where js=0 group by uid ");
		Db.update("update sp_wxincome set js=1,stat=1 where js=0");
		//更新微信用户表信息 累加已结奖金返利，重置新增返利和新增奖金
		Db.update("update "+WxUser.tableName+" set fanli=fanli+fanli1,fanli1=0,fanli2=0,bonus=bonus+bonus1,bonus1=0,bonus2=0,buyct=0 where jbm!=0");
	}
	/***
	 * 查询月收入明细
	 * @param m1 上月
	 * @param m2 本月
	 * @return
	 */
	public List findIncomeNowMonth(String m1, String m2) {
		return Db.find("select u.id,u.nickname,u.uname,u.phone,case when u.jbm=2 then '帮主' else '帮友' end as jbm,u.account,t.amt,case when t.typ=1 then '酒帮奖' else '返利' end as typ,t.ctime from "+tableName+" t,"+WxUser.tableName+" u where u.openid=t.openid and t.ctime between ? and ?",m1,m2);
	}
	/***
	 * 查询月结算明细
	 * @param m1 上月
	 * @param m2 本月
	 * @return
	 */
	public List findNowMonth(String m1, String m2) {
		return Db.find("select u.id,u.nickname,u.uname,u.phone,u.bank,u.account,sum(t.AMT)amt from sp_jsrecord t,"+WxUser.tableName+" u where u.openid=t.openid and t.ctime between ? and ? group by u.id",m1,m2);
	}
}
