package net.loyin.wechat;

import java.util.ArrayList;
import java.util.List;

import net.loyin.model.sys.WxUser;

import org.apache.log4j.Logger;

import com.alibaba.fastjson.JSONObject;
import com.gson.WeChat;
import com.gson.bean.Articles;
import com.gson.bean.InMessage;
import com.gson.bean.NewsOutMessage;
import com.gson.bean.OutMessage;
import com.gson.bean.TextOutMessage;
import com.gson.inf.MessageProcessingHandler;

/**
 * 消息处理
 * @author 龙影
 */
public class MessageProcessingHandlerImpl implements MessageProcessingHandler{
	private static final Logger log=Logger.getLogger(MessageProcessingHandlerImpl.class);
	private OutMessage outMessage;
	@Override
	public void allType(InMessage msg) {
		TextOutMessage out = new TextOutMessage();
		out.setContent("您的消息已经收到！您发送的是"+msg.getMsgType()+"消息");
		setOutMessage(out);
	}
	@Override
	public void textTypeMsg(InMessage msg) {
	}
	@Override
	public void locationTypeMsg(InMessage msg) {
	}
	@Override
	public void imageTypeMsg(InMessage msg) {
	}
	@Override
	public void videoTypeMsg(InMessage msg) {
	}
	@Override
	public void linkTypeMsg(InMessage msg) {
	}
	@Override
	public void voiceTypeMsg(InMessage msg) {
	}
	@Override
	public void verifyTypeMsg(InMessage msg) {
	}
	/**菜单点击事件*/
	@Override
	public void eventTypeMsg(InMessage msg) {
		String event=msg.getEvent();//CLICK
		String eventKey=msg.getEventKey();
		String openid=msg.getFromUserName();
		OutMessage out=null;
		String msgContent="";
		try{
			WxUser wxuser=WxUser.dao.findByOpenId(openid);
			if(wxuser==null){
				try{
				wxuser=WxUser.dao.getFromOpenId(openid);
				}catch(Exception e){log.error("获取用户信息异常",e);}
			}
			 String accessToken=WeChat.getAccessToken();
			log.debug("event:\t"+event+"\teventKey:\t"+eventKey);
			if("MENU1".equals(eventKey)){//古酿商城
				log.debug("古酿商城");
				msgContent="古酿商城";
			}else
			if("MENU2".equals(eventKey)){//古酿酒帮
				log.debug("古酿酒帮");
				msgContent="古酿酒帮";
			}else
			if("MENU21".equals(eventKey)){//创建酒帮
				log.debug("创建酒帮");
				msgContent="创建酒帮";
			}else
			if("MENU22".equals(eventKey)){//我的酒帮
				log.debug("我的酒帮");
				msgContent="我的酒帮";
			}else
			if("MENU23".equals(eventKey)){//招募成员
				log.debug("招募成员");
				JSONObject json=WeChat.qrcod.createScene(accessToken,1800,wxuser.getLong("id").intValue());
				String picurl=WeChat.qrcod.showqrcodeUrl(json.getString("ticket"));
				NewsOutMessage msg_jrjb=new NewsOutMessage();
				msg_jrjb.setTitle("招募成员");
				msg_jrjb.setUrl(picurl);
				msg_jrjb.setDescription("请扫描此二维码加入我的酒帮");
				List<Articles> articlesList=new ArrayList<Articles>();
				Articles arts=new Articles();
				arts.setPicUrl(picurl);
				arts.setUrl(picurl);
				arts.setTitle("招募成员");
				arts.setDescription("请扫描此二维码加入我的酒帮");
				articlesList.add(arts);
				msg_jrjb.setArticles(articlesList);
				out=msg_jrjb;
			}else
			if("MENU3".equals(eventKey)){//关于古酿
				log.debug("关于古酿");
				msgContent="关于古酿";
			}else
			if("MENU31".equals(eventKey)){//在线客服
				log.debug("在线客服");
				msgContent="在线客服";
			}else if("subscribe".equals(eventKey)){//首次关注
				log.debug("首次关注");
				msgContent="欢迎您关注我们！";
			}
		}catch(Exception e){
			log.error("处理事件消息异常",e);
			msgContent="系统运行错误，参数错误！";
		}
		if(out==null&&!"".equals(msgContent)){
			TextOutMessage tout=new TextOutMessage();
			tout.setContent(msgContent);
			out=tout;
		}
		setOutMessage(out);
	}

	@Override
	public void afterProcess(InMessage inMsg, OutMessage outMsg) {
	}

	@Override
	public void setOutMessage(OutMessage outMessage) {
		this.outMessage=outMessage;
	}

	@Override
	public OutMessage getOutMessage() {
		return outMessage;
	}
}
