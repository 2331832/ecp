package net.loyin.ctrl;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import com.gson.WeChat;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Page;
import com.jfinal.plugin.activerecord.Record;

import net.loyin.jfinal.anatation.RouteBind;
import net.loyin.model.sys.WxOrder;

/***
 * 微信订单
 * @author xd
 */
@RouteBind(path="/wxOrder")
public class WxOrderCtrl extends AdminBaseController<WxOrder>{
	public WxOrderCtrl(){
		this.tableName=WxOrder.tableName;
		this.modelClass=WxOrder.class;
	}
	public void list(){
		String openid=this.getPara("openid");
		List<Object> param = new ArrayList<Object>();
		StringBuffer where = new StringBuffer();
		/** 添加查询字段条件*/
		if(openid!=null&&!"".equals(openid)){
			param.add(openid);
			where.append(" and buyer_openid=? ");
		}
		qryField(where, param);
		sortField(where);
		Page<Record> p = Db.paginate(getPageNo(), getPageSize(), "select t.* ", "from " + this.tableName+ " t where 1=1 " + where.toString(), param.toArray());
		this.setAttr("page", p);
	
	}
	public void view(){
		Long id=this.getParaToLong(0);
		WxOrder wxorder=WxOrder.dao.findById(id);
		//获取订单详情
		try {
			Map order=WeChat.orderInfo(wxorder.getStr("order_id"));
			wxorder.setAttrs(order);
			wxorder.update();
		} catch (Exception e) {
		}
		this.setAttr("po",wxorder);
	}
}
