package net.loyin.model.sys;

import java.math.BigDecimal;
import java.util.Map;

import net.loyin.jfinal.anatation.TableBind;
import net.loyin.util.PropertiesContent;

import com.jfinal.aop.Before;
import com.jfinal.plugin.activerecord.Db;
import com.jfinal.plugin.activerecord.Model;
import com.jfinal.plugin.activerecord.Record;
import com.jfinal.plugin.activerecord.tx.Tx;
/**
 * 微信订单
 * @author xd
 */
@TableBind(name="sp_wx_order")
public class WxOrder extends Model<WxOrder> {
	private static final long serialVersionUID = -5978356525715363974L;
	public static final String tableName="sp_wx_order";
	public static WxOrder dao=new WxOrder();
	@Before(Tx.class)
	public void install(Map<String,Object> attrs){
		BigDecimal orderTotalPrice=new BigDecimal(Float.parseFloat(attrs.get("order_total_price").toString())/100);
		attrs.put("order_total_price",orderTotalPrice);//订单金额 转成元
		attrs.put("product_price",new BigDecimal(Float.parseFloat(attrs.get("product_price").toString())/100));//商品价格 转成元
		attrs.put("order_express_price",new BigDecimal(Float.parseFloat(attrs.get("order_express_price").toString())/100));//运费 转成元
		WxOrder wxOrder=new WxOrder();
		wxOrder.setAttrs(attrs);
		wxOrder.save();
		String openid_=(String)attrs.get("buyer_openid");
		WxUser u=WxUser.dao.findByOpenId(openid_);
		int shopcount_=u.getInt("shopcount");
		u.set("shopcount", shopcount_+1);
		BigDecimal amt=u.getBigDecimal("amt");
		if(amt==null){
			amt=new BigDecimal(0);
		}
		BigDecimal fanli=u.getBigDecimal("fanli");
		if(fanli==null){
			fanli=new BigDecimal(0);
		}
		//用与计算酒帮奖金
		BigDecimal fanli2=u.getBigDecimal("fanli2");
		if(fanli2==null){
			fanli2=new BigDecimal(0);
		}
		/**首次购买折扣*/
		float first_buy_discount=Float.parseFloat(PropertiesContent.get("first_buy_discount"));
		/**购买折扣*/
		float buy_discount=Float.parseFloat(PropertiesContent.get("buy_discount"));
		//计算打折返利
		if(shopcount_==0){//打8折 初次购买
			fanli=fanli.add(orderTotalPrice.multiply(new BigDecimal(first_buy_discount)));
			fanli2=fanli2.add(orderTotalPrice.multiply(new BigDecimal(first_buy_discount)));
		}else{//打88折
			fanli=fanli.add(orderTotalPrice.multiply(new BigDecimal(buy_discount)));
			fanli2=fanli2.add(orderTotalPrice.multiply(new BigDecimal(buy_discount)));
		}
		amt=amt.add(orderTotalPrice);
		u.set("amt",amt);//统计消费金额
		u.set("fanli",fanli);
		BigDecimal Bonus1=u.getBigDecimal("Bonus1");
		if(Bonus1==null){
			Bonus1=new BigDecimal(0);
		}
		Bonus1=Bonus1.add(fanli);
		u.set("Bonus1",Bonus1);
		u.set("buyct", 1);//设置计算帮主奖金用 0时为已经统计过或未购买了，需要重新购买后才能计算其帮主奖金
		u.update();
		String jbopenid=u.getStr("jbopenid");
		if(jbopenid!=null){
			//计算其帮主获得的20%的返利
			BigDecimal fanli1=orderTotalPrice.multiply(new BigDecimal(first_buy_discount));
			Db.update("update "+u.tableName+" set fanli=fanli+?,fanli2=fanli2+? where openid=?",fanli1,fanli2,jbopenid);
	//		if(jbm==2){//帮主 计算帮主奖 当所有的成员购买了
	//			u.jiuBangBonus(u.getStr("jbopenid"));
			//获取目前酒帮成员购买次数 即是否8个成员都购买了
			Record r = Db.findFirst("SELECT sum(u.buyct)ct FROM "+ u.tableName+ " u WHERE u.buyct!=0 and u.jbopenid=?",jbopenid);
			if(r!=null){
				Long count=r.getLong("ct");
				if(count>=8){
					//计算奖金
					Db.update("update "+u.tableName+" u set u.Bonus1=u1.fanli2*0.5 where u.openid=? ",jbopenid);//单次酒帮奖及返利
					Db.update("update "+u.tableName+" u set u.Bonus=u.Bonus+Bonus1,u.fanli2=0 where u.openid=? ",jbopenid);//累计酒帮奖 
																												//重置成员用于计算酒帮奖金返利
					Db.update("update "+u.tableName+" u set u.buyct=0 where jbopenid=?",jbopenid);//重置成员购买统计次数
				}
			}
		}
	//		}
	}
}
